# 宝牌（ドラ）规则详解

宝牌是立直麻将中增加番数的重要机制，但不构成役。

## 一、宝牌的基本概念

### 1.1 定义

宝牌是指**可以增加番数**的牌，每张宝牌 = 1番。

### 1.2 核心特性

- **不算役**：宝牌本身不是役种
- **可叠加**：可以与其他役种叠加
- **无役不能和牌**：仅有宝牌不能和牌，必须有至少1个役

## 二、宝牌的类型

### 2.1 表宝牌（表ドラ）

#### 定义

由**宝牌指示牌**确定的宝牌。

#### 宝牌指示牌

- **位置**：王牌最上方
- **翻开时机**：开局时翻开
- **数量**：通常1张，流局时可能增加

#### 宝牌确定规则

##### 数牌（1-9）

```
指示牌 → 宝牌
1 → 2
2 → 3
3 → 4
4 → 5
5 → 6
6 → 7
7 → 8
8 → 9
9 → 1（循环）
```

##### 风牌

```
指示牌 → 宝牌
东 → 南
南 → 西
西 → 北
北 → 东（循环）
```

##### 三元牌

```
指示牌 → 宝牌
白 → 发
发 → 中
中 → 白（循环）
```

#### 示例

```
宝牌指示牌：3万
→ 宝牌：4万

如果手牌中有：
- 1张4万 = 1番
- 2张4万 = 2番
- 3张4万 = 3番
- 4张4万 = 4番
```

### 2.2 里宝牌（裏ドラ）

#### 定义

**立直和牌时**，可以翻开里宝牌指示牌，获得额外的宝牌。

#### 条件

- **必须立直**：只有立直和牌时才能翻开
- **位置**：表宝牌指示牌下方的牌
- **计算**：同样规则确定宝牌

#### 示例

```
表宝牌指示牌：3万 → 表宝牌4万
里宝牌指示牌：5筒 → 里宝牌6筒

立直和牌时：
- 手牌中有4万 = 1番（表宝牌）
- 手牌中有6筒 = 1番（里宝牌）
- 总计：2番宝牌
```

### 2.3 赤宝牌（赤ドラ）

#### 定义

部分规则使用**赤牌**（红色的5），每张赤牌 = 1番。

#### 规则

- **数量**：5万、5筒、5索各1张为赤牌
- **总计**：3张赤牌
- **计算**：每张赤牌 = 1番

#### 示例

```
手牌中有：
- 1张赤5万 = 1番
- 1张赤5筒 = 1番
- 1张赤5索 = 1番
- 总计：3番赤宝牌
```

### 2.4 杠宝牌（カンドラ）

#### 定义

**开杠时**，翻开新的宝牌指示牌。

#### 规则

- **每次开杠**：翻开1张新的宝牌指示牌
- **累积**：宝牌指示牌可以累积
- **计算**：每张指示牌确定1种宝牌

#### 示例

```
开局：1张宝牌指示牌（3万 → 宝牌4万）
开杠1：+1张宝牌指示牌（5筒 → 宝牌6筒）
开杠2：+1张宝牌指示牌（7索 → 宝牌8索）

当前宝牌：
- 4万（1番）
- 6筒（1番）
- 8索（1番）
```

## 三、宝牌的计算

### 3.1 基本计算

#### 方法

1. **确定宝牌种类**：根据指示牌确定
2. **统计手牌**：统计手牌中宝牌的数量
3. **计算番数**：每张宝牌 = 1番

#### 示例

```
宝牌指示牌：3万 → 宝牌4万

手牌：
- 4万 4万（2张宝牌）
- 其他牌...

宝牌番数：2番
```

### 3.2 复合宝牌

#### 多种宝牌叠加

```
表宝牌：4万（手牌中2张）= 2番
里宝牌：6筒（手牌中1张）= 1番
赤宝牌：赤5万（手牌中1张）= 1番

总计：4番宝牌
```

#### 杠宝牌叠加

```
宝牌指示牌1：4万（手牌中1张）= 1番
宝牌指示牌2：6筒（手牌中2张）= 2番
宝牌指示牌3：8索（手牌中0张）= 0番

总计：3番宝牌
```

### 3.3 宝牌与役的叠加

#### 规则

- **宝牌不算役**：宝牌本身不是役
- **必须至少有1个役**：无役不能和牌
- **可以叠加**：宝牌 + 役种 = 总番数

#### 示例

```
役种：
- 立直（1番）
- 断幺九（1番）
- 三色同顺（2番）
总计：4番

宝牌：
- 表宝牌（2张）= 2番
- 里宝牌（1张）= 1番
总计：3番

最终番数：4番（役） + 3番（宝牌） = 7番（跳满）
```

## 四、宝牌的特殊情况

### 4.1 无役和牌

#### 规则

- **不能和牌**：仅有宝牌不能和牌
- **必须有役**：必须有至少1个役种

#### 示例

```
手牌：
- 只有宝牌，无任何役
→ 不能和牌

手牌：
- 宝牌（3番）
- 断幺九（1番）
→ 可以和牌，总计4番
```

### 4.2 宝牌指示牌的变化

#### 流局时

- **可能增加**：流局时可能翻开新的宝牌指示牌
- **累积**：宝牌指示牌累积

#### 开杠时

- **每次开杠**：翻开1张新的宝牌指示牌
- **立即生效**：开杠后立即生效

### 4.3 里宝牌的限制

#### 条件

- **必须立直**：只有立直和牌时才能翻开
- **自摸和荣和**：立直自摸和立直荣和都可以

#### 不能翻开的情况

- **未立直**：未立直和牌时不能翻开
- **流局**：流局时不能翻开

## 五、开发实现

### 5.1 宝牌指示牌管理

```go
type DoraIndicator struct {
    Tile      Tile
    IsRevealed bool
}

type DoraManager struct {
    TableDoraIndicators []DoraIndicator // 表宝牌指示牌
    UraDoraIndicators   []DoraIndicator // 里宝牌指示牌
}

func (dm *DoraManager) RevealTableDora(tile Tile) {
    dm.TableDoraIndicators = append(dm.TableDoraIndicators, DoraIndicator{
        Tile:       tile,
        IsRevealed: true,
    })
}

func (dm *DoraManager) RevealUraDora(tile Tile) {
    dm.UraDoraIndicators = append(dm.UraDoraIndicators, DoraIndicator{
        Tile:       tile,
        IsRevealed: true,
    })
}
```

### 5.2 宝牌计算

```go
func CalculateDora(tile Tile) Tile {
    if tile.IsNumbered() {
        // 数牌：+1，9→1循环
        if tile.Number == 9 {
            return Tile{Type: tile.Type, Number: 1}
        }
        return Tile{Type: tile.Type, Number: tile.Number + 1}
    } else if tile.IsWind() {
        // 风牌：东→南→西→北→东
        nextWind := (tile.Wind + 1) % 4
        return Tile{Type: WindToTileType(nextWind)}
    } else if tile.IsDragon() {
        // 三元牌：白→发→中→白
        nextDragon := (tile.Dragon + 1) % 3
        return Tile{Type: DragonToTileType(nextDragon)}
    }
    return Tile{}
}

func CountDora(hand []Tile, doraIndicators []Tile, isRiichiWin bool, uraDoraIndicators []Tile) int {
    doraCount := 0
    
    // 表宝牌
    for _, indicator := range doraIndicators {
        doraTile := CalculateDora(indicator)
        count := CountTile(hand, doraTile)
        doraCount += count
    }
    
    // 里宝牌（仅立直和牌时）
    if isRiichiWin {
        for _, indicator := range uraDoraIndicators {
            doraTile := CalculateDora(indicator)
            count := CountTile(hand, doraTile)
            doraCount += count
        }
    }
    
    // 赤宝牌
    for _, tile := range hand {
        if tile.IsRedFive() {
            doraCount++
        }
    }
    
    return doraCount
}
```

### 5.3 和牌判定（含宝牌）

```go
func CheckWinWithDora(hand []Tile, winTile Tile, isTsumo bool, isRiichi bool) (bool, int, []Yaku) {
    // 1. 检查基本和牌条件
    if !CanWin(hand, winTile) {
        return false, 0, nil
    }
    
    // 2. 检查役
    yakus := CheckYaku(hand, winTile, isTsumo, isRiichi)
    if len(yakus) == 0 {
        return false, 0, nil // 无役不能和牌
    }
    
    // 3. 计算役番数
    han := 0
    for _, yaku := range yakus {
        han += yaku.Han
    }
    
    // 4. 计算宝牌番数
    doraHan := CountDora(hand, game.DoraIndicators, isRiichi, game.UraDoraIndicators)
    
    // 5. 总番数
    totalHan := han + doraHan
    
    return true, totalHan, yakus
}
```

## 六、常见问题

### Q1: 宝牌算役吗？

**A**: 不算。宝牌本身不是役种，只是增加番数。

### Q2: 只有宝牌能和牌吗？

**A**: 不能。必须有至少1个役种才能和牌。

### Q3: 里宝牌什么时候翻开？

**A**: 立直和牌时翻开。未立直和牌时不能翻开。

### Q4: 开杠会增加宝牌吗？

**A**: 会。每次开杠翻开1张新的宝牌指示牌。

### Q5: 赤宝牌怎么计算？

**A**: 每张赤牌 = 1番。如果使用赤牌规则，手牌中的赤牌都算宝牌。

## 总结

宝牌是立直麻将的重要机制：

1. **类型多样**：表宝牌、里宝牌、赤宝牌、杠宝牌
2. **不算役**：宝牌本身不是役，但可以增加番数
3. **必须搭配役**：无役不能和牌，必须有至少1个役
4. **可以叠加**：多种宝牌可以叠加，与役种也可以叠加

在开发实现时，需要准确计算各种宝牌，正确处理宝牌与役种的关系，确保游戏规则的正确性。

