# 立直（リーチ）规则详解

立直是立直麻将中最重要的进攻手段之一，也是最具特色的规则。

## 一、立直的基本概念

### 1.1 定义

立直是指玩家在**门清听牌**状态下，支付1000点，宣布进入"立直状态"的行为。

### 1.2 立直的意义

- **增加1番**：立直本身是1番役
- **可能触发一发**：立直后1巡内和牌可再+1番
- **心理压力**：向对手宣告听牌状态
- **获得立直棒**：和牌时可获得所有立直棒

## 二、立直的条件

### 2.1 必要条件（全部满足）

1. **门清状态**
   - 无吃、碰、明杠
   - 可以有暗杠（但需注意限制）

2. **听牌状态**
   - 已听牌（至少1张有效牌）
   - 听牌型可以是任何类型

3. **点数足够**
   - 当前点数 ≥ 1000点
   - 支付1000点后点数 ≥ 0

4. **非振听状态**
   - 不能处于振听状态
   - 必须可以荣和

5. **非最后巡**
   - 不是最后一张牌
   - 牌山至少还有1张牌

### 2.2 禁止立直的情况

- 已鸣牌（吃、碰、明杠）
- 未听牌
- 点数不足1000
- 处于振听状态
- 最后一张牌
- 已立直（不能重复立直）

## 三、立直的操作流程

### 3.1 立直时机

立直必须在**摸牌后、打牌前**进行：

```
1. 摸牌
   ↓
2. 判断是否可以立直
   ↓
3. 选择立直（支付1000点）
   ↓
4. 打出一张牌（必须打牌）
   ↓
5. 进入立直状态
```

### 3.2 立直操作步骤

1. **支付1000点**
   - 从当前点数扣除1000点
   - 放置立直棒（供托）

2. **打出一张牌**
   - 必须打出一张牌
   - 这张牌不能改变听牌

3. **宣布立直**
   - 向所有玩家广播立直信息
   - 显示立直标识

## 四、立直后的限制

### 4.1 不能进行的操作

- **不能吃**：完全禁止
- **不能碰**：完全禁止
- **不能明杠**：完全禁止
- **不能改变打牌习惯**：必须按固定顺序打牌

### 4.2 可以进行的操作

- **可以暗杠**：但有严格限制
- **可以自摸**：不受限制
- **可以荣和**：不受限制（非振听时）

### 4.3 暗杠的限制

立直后可以暗杠，但必须满足：

1. **听牌不能改变**
   - 暗杠后听牌必须完全相同
   - 如果改变听牌，立直失效

2. **一发失效**
   - 立直后暗杠，"一发"立即失效
   - 即使1巡内和牌也没有一发

3. **必须可以暗杠**
   - 手牌中有4张相同牌
   - 暗杠后仍听牌

## 五、一发（イッパツ）

### 5.1 定义

立直后**1巡内**和牌，可以额外获得1番。

### 5.2 条件

1. **已立直**
2. **1巡内和牌**
   - 立直后第一次摸牌或第一次可以荣和时
   - 必须在1巡内

### 5.3 失效条件

以下情况会导致"一发"失效：

1. **立直后暗杠**
   - 立即失效

2. **其他玩家鸣牌**
   - 任何玩家吃、碰、杠
   - 跳过自己的回合

3. **超过1巡**
   - 已经过1巡
   - 下次摸牌时已失效

### 5.4 一发示例

```
玩家A立直，打出一张牌
   ↓
玩家B摸牌（不鸣牌）
   ↓
玩家C摸牌（不鸣牌）
   ↓
玩家D摸牌（不鸣牌）
   ↓
玩家A摸牌 → 自摸和牌
   → 有"一发"（+1番）
```

如果玩家B碰牌，则玩家A的"一发"失效。

## 六、立直棒（リーチ棒）

### 6.1 立直棒的作用

- **放置**：立直时支付的1000点
- **归属**：下次和牌者获得所有立直棒
- **累积**：多人立直时累积

### 6.2 立直棒的处理

#### 和牌时
- **和牌者获得**：所有立直棒
- **计算**：和牌得分 + 立直棒数量 × 1000

#### 流局时
- **保留**：立直棒保留到下一局
- **累积**：继续累积

### 6.3 立直棒示例

```
玩家A立直 → 支付1000点（立直棒1本）
玩家B立直 → 支付1000点（立直棒2本）
玩家C和牌 → 获得2000点（立直棒2本）
```

## 七、立直的策略

### 7.1 立直的时机

#### 适合立直的情况

1. **听牌好**
   - 听牌型好（如两面听）
   - 有效牌多

2. **点数充足**
   - 点数足够支付1000点
   - 立直后仍有足够点数

3. **场况有利**
   - 其他玩家未听牌
   - 可以施加压力

4. **追求速度**
   - 需要快速和牌
   - 点数领先时

#### 不适合立直的情况

1. **听牌差**
   - 听牌型差（如单骑、边张）
   - 有效牌少

2. **点数紧张**
   - 点数接近0
   - 立直后可能被击飞

3. **场况不利**
   - 其他玩家已听牌
   - 防守更重要

4. **追求大牌**
   - 想做更大的牌
   - 立直会限制选择

### 7.2 立直后的策略

#### 进攻策略

- **保持听牌**：不能改变听牌
- **等待和牌**：等待自摸或荣和
- **施加压力**：通过立直给对手压力

#### 防守策略（对手立直时）

- **谨慎打牌**：避免放铳
- **观察牌河**：分析对手听牌
- **优先安全牌**：打现物、筋牌

## 八、立直的特殊情况

### 8.1 双重立直（ダブルリーチ）

- **定义**：第一巡内立直
- **规则**：部分规则中算2番
- **标准规则**：仍为1番（不算特殊役）

### 8.2 立直一发自摸

- **组合**：立直 + 一发 + 门前清自摸和
- **番数**：3番
- **常见**：非常常见的和牌方式

### 8.3 立直后振听

- **情况**：立直后可以荣和但选择不荣和
- **结果**：进入立直后振听
- **影响**：只能自摸，不能荣和

## 九、开发实现

### 9.1 立直判定

```go
func CanRiichi(player *Player, game *Game) bool {
    // 1. 检查门清
    if len(player.Melds) > 0 {
        return false
    }
    
    // 2. 检查听牌
    waits := CheckTenpai(player.Hand)
    if len(waits) == 0 {
        return false
    }
    
    // 3. 检查点数
    if player.Points < 1000 {
        return false
    }
    
    // 4. 检查振听
    if player.IsFuriten {
        return false
    }
    
    // 5. 检查最后巡
    if game.IsLastTile() {
        return false
    }
    
    // 6. 检查已立直
    if player.IsRiichi {
        return false
    }
    
    return true
}
```

### 9.2 立直执行

```go
func ExecuteRiichi(player *Player, discardTile Tile) error {
    // 1. 验证条件
    if !CanRiichi(player, game) {
        return errors.New("不能立直")
    }
    
    // 2. 支付1000点
    player.Points -= 1000
    game.RiichiSticks++
    
    // 3. 打牌
    if !player.Discard(discardTile) {
        return errors.New("打牌失败")
    }
    
    // 4. 设置立直状态
    player.IsRiichi = true
    player.RiichiTurn = game.TurnNumber
    
    // 5. 广播
    game.BroadcastRiichi(player.Index)
    
    return nil
}
```

### 9.3 一发检查

```go
func CheckIppatsu(player *Player, game *Game) bool {
    if !player.IsRiichi {
        return false
    }
    
    // 检查是否在1巡内
    turnsSinceRiichi := game.TurnNumber - player.RiichiTurn
    if turnsSinceRiichi > 1 {
        return false
    }
    
    // 检查是否暗杠过
    if player.HasAnkanAfterRiichi {
        return false
    }
    
    // 检查是否有其他玩家鸣牌
    if game.HasMeldAfterRiichi(player.Index) {
        return false
    }
    
    return true
}
```

### 9.4 立直后暗杠检查

```go
func CanAnkanAfterRiichi(player *Player, kanTile Tile) bool {
    if !player.IsRiichi {
        return false
    }
    
    // 模拟暗杠
    newHand := player.Hand.Clone()
    newHand.RemoveTile(kanTile, 4)
    
    // 检查听牌是否改变
    oldWaits := CheckTenpai(player.Hand)
    newWaits := CheckTenpai(newHand)
    
    if !waitsEqual(oldWaits, newWaits) {
        return false
    }
    
    return true
}
```

## 十、常见问题

### Q1: 立直后可以改变听牌吗？

**A**: 不可以。立直后打牌必须保持听牌不变。如果暗杠后听牌改变，立直失效。

### Q2: 立直后可以自摸吗？

**A**: 可以。立直后可以自摸和牌，不受任何限制。

### Q3: 立直后可以荣和吗？

**A**: 可以，但必须非振听。如果处于振听状态，只能自摸。

### Q4: 立直后暗杠会怎样？

**A**: 
- 如果听牌不变：可以暗杠，但"一发"失效
- 如果听牌改变：不能暗杠（或立直失效）

### Q5: 立直棒什么时候获得？

**A**: 下次和牌时获得所有立直棒。流局时保留到下一局。

## 总结

立直是立直麻将的核心机制，需要：

1. **理解条件**：门清、听牌、点数、非振听
2. **掌握时机**：根据场况判断是否立直
3. **遵守限制**：立直后的操作限制
4. **利用优势**：立直+一发的高番数组合

在开发实现时，需要严格验证立直条件，正确处理立直后的限制，确保游戏规则的正确性。

