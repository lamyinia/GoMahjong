# 流局（流し）规则详解

流局是立直麻将中重要的结束机制，有多种类型和处理方式。

## 一、流局的基本概念

### 1.1 定义

流局是指**一局游戏未有人和牌**而结束的情况。

### 1.2 流局的意义

- **游戏继续**：流局后继续下一局
- **点数结算**：按听牌状态结算点数
- **连庄判定**：根据庄家听牌状态决定是否连庄

## 二、流局的类型

### 2.1 荒牌流局（流し）

#### 定义

**牌山摸完**，无人和牌。

#### 条件

- **牌山枯竭**：所有可摸的牌都已摸完
- **无人和牌**：本局无人和牌

#### 处理

1. **听牌罚符**：不听者支付听牌者
2. **连庄判定**：根据庄家听牌状态

### 2.2 九种九牌（九種九牌）

#### 定义

**第一巡摸牌后**，手牌有9种以上幺九牌。

#### 条件

- **第一巡**：必须是第一巡
- **摸牌后**：摸牌后判断
- **9种以上**：手牌中有9种或更多幺九牌

#### 处理

- **可选择流局**：玩家可以选择流局
- **不强制**：不是强制流局

#### 示例

```
第一巡摸牌后手牌：
1万 9万 东 南 西 北 白 发 中 1筒 9筒
→ 11种幺九牌
→ 可以选择流局
```

### 2.3 四风连打（四風連打）

#### 定义

**第一巡**，四人打出相同风牌。

#### 条件

- **第一巡**：必须是第一巡
- **相同风牌**：四人打出相同的风牌（东、南、西、北）
- **连续打出**：按顺序连续打出

#### 处理

- **强制流局**：立即流局
- **不结算**：不进行听牌罚符

#### 示例

```
第一巡：
玩家A打出：东
玩家B打出：东
玩家C打出：东
玩家D打出：东
→ 四风连打，流局
```

### 2.4 四杠散了（四カン散らし）

#### 定义

**四人各开一杠**。

#### 条件

- **四人各一杠**：每人至少开1个杠
- **总计4杠**：四人共开4个杠

#### 处理

- **强制流局**：立即流局
- **不结算**：不进行听牌罚符

#### 示例

```
玩家A：开杠（1杠）
玩家B：开杠（2杠）
玩家C：开杠（3杠）
玩家D：开杠（4杠）
→ 四杠散了，流局
```

### 2.5 三家和（三家和）

#### 定义

**三人同时荣和**同一张牌。

#### 条件

- **三人同时**：三人同时可以荣和
- **同一张牌**：荣和的是同一张牌

#### 处理

- **部分规则流局**：部分规则中算流局
- **标准规则**：按一炮多响处理

#### 示例

```
玩家A打出：3万
玩家B：可以荣和3万
玩家C：可以荣和3万
玩家D：可以荣和3万
→ 三家和（部分规则流局）
```

### 2.6 四家立直（四家立直）

#### 定义

**四人全部立直**。

#### 条件

- **四人立直**：四人都已立直

#### 处理

- **部分规则流局**：部分规则中算流局
- **标准规则**：继续游戏

## 三、流局结算

### 3.1 听牌罚符（ノーテン罰符）

#### 基本规则

- **不听者支付听牌者**
- **标准金额**：不听者支付1000点
- **庄家特殊**：庄家不听支付1500点

#### 结算方式

##### 情况1：庄家听牌，闲家有听

```
庄家：听牌
闲家A：听牌
闲家B：不听
闲家C：不听

结算：
- 闲家B支付：庄家1000点，闲家A1000点 = 2000点
- 闲家C支付：庄家1000点，闲家A1000点 = 2000点
- 庄家获得：2000点
- 闲家A获得：2000点
```

##### 情况2：庄家听牌，闲家全不听

```
庄家：听牌
闲家A：不听
闲家B：不听
闲家C：不听

结算：
- 闲家A支付：庄家1000点 = 1000点
- 闲家B支付：庄家1000点 = 1000点
- 闲家C支付：庄家1000点 = 1000点
- 庄家获得：3000点
```

##### 情况3：庄家不听，闲家有听

```
庄家：不听
闲家A：听牌
闲家B：听牌
闲家C：不听

结算：
- 庄家支付：闲家A1500点，闲家B1500点 = 3000点
- 闲家C支付：闲家A1000点，闲家B1000点 = 2000点
- 闲家A获得：2500点
- 闲家B获得：2500点
```

##### 情况4：全不听牌

```
庄家：不听
闲家A：不听
闲家B：不听
闲家C：不听

结算：
- 无罚符
- 点数不变
```

### 3.2 连庄判定

#### 庄家听牌

- **继续坐庄**：庄家继续坐庄
- **本场+1**：本场数+1

#### 庄家不听

- **下庄**：庄家下庄
- **本场重置**：本场数重置为0
- **轮庄**：轮到下家坐庄

### 3.3 立直棒处理

#### 流局时

- **保留**：立直棒保留到下一局
- **累积**：继续累积

#### 和牌时

- **获得**：和牌者获得所有立直棒

## 四、开发实现

### 4.1 流局判定

```go
func CheckDrawConditions(game *Game) (bool, DrawType) {
    // 1. 检查荒牌流局
    if game.Wall.IsExhausted() {
        return true, DrawTypeExhaustive
    }
    
    // 2. 检查九种九牌
    if game.TurnNumber == 1 {
        for _, player := range game.Players {
            if CheckKyuushuKyuuhai(player) {
                return true, DrawTypeKyuushuKyuuhai
            }
        }
    }
    
    // 3. 检查四风连打
    if game.TurnNumber == 1 {
        if CheckSuufonRenda(game) {
            return true, DrawTypeSuufonRenda
        }
    }
    
    // 4. 检查四杠散了
    if CheckSuukanSanra(game) {
        return true, DrawTypeSuukanSanra
    }
    
    return false, DrawTypeNone
}
```

### 4.2 听牌罚符结算

```go
func CalculateTenpaiPenalty(game *Game) map[int]int {
    payments := make(map[int]int)
    
    // 统计听牌状态
    tenpaiPlayers := []int{}
    notenPlayers := []int{}
    
    for i, player := range game.Players {
        if player.IsTenpai {
            tenpaiPlayers = append(tenpaiPlayers, i)
        } else {
            notenPlayers = append(notenPlayers, i)
        }
    }
    
    // 全不听牌，无罚符
    if len(tenpaiPlayers) == 0 {
        return payments
    }
    
    // 计算罚符
    penaltyAmount := 1000
    dealerPenaltyAmount := 1500
    
    for _, notenIndex := range notenPlayers {
        notenPlayer := game.Players[notenIndex]
        isDealer := notenIndex == game.DealerIndex
        
        for _, tenpaiIndex := range tenpaiPlayers {
            tenpaiPlayer := game.Players[tenpaiIndex]
            
            amount := penaltyAmount
            if isDealer {
                amount = dealerPenaltyAmount
            }
            
            payments[notenIndex] -= amount
            payments[tenpaiIndex] += amount
        }
    }
    
    return payments
}
```

### 4.3 连庄判定

```go
func CheckRenchan(game *Game) bool {
    dealer := game.Players[game.DealerIndex]
    
    // 庄家听牌，继续坐庄
    if dealer.IsTenpai {
        return true
    }
    
    // 庄家不听，下庄
    return false
}
```

### 4.4 九种九牌判定

```go
func CheckKyuushuKyuuhai(player *Player) bool {
    // 统计幺九牌种类
    yaochuTypes := make(map[TileType]bool)
    
    for _, tile := range player.Hand {
        if tile.IsYaochu() {
            yaochuTypes[tile.Type] = true
        }
    }
    
    // 检查是否有9种以上
    return len(yaochuTypes) >= 9
}
```

### 4.5 四风连打判定

```go
func CheckSuufonRenda(game *Game) bool {
    if game.TurnNumber != 1 {
        return false
    }
    
    // 检查第一巡的舍牌
    if len(game.Discards) < 4 {
        return false
    }
    
    firstFourDiscards := game.Discards[:4]
    
    // 检查是否都是风牌
    for _, discard := range firstFourDiscards {
        if !discard.Tile.IsWind() {
            return false
        }
    }
    
    // 检查是否相同
    firstWind := firstFourDiscards[0].Tile.Wind
    for _, discard := range firstFourDiscards {
        if discard.Tile.Wind != firstWind {
            return false
        }
    }
    
    return true
}
```

### 4.6 四杠散了判定

```go
func CheckSuukanSanra(game *Game) bool {
    kanCount := 0
    kanByPlayer := make(map[int]int)
    
    for _, player := range game.Players {
        for _, meld := range player.Melds {
            if meld.Type == MeldTypeKan {
                kanCount++
                kanByPlayer[player.Index]++
            }
        }
    }
    
    // 检查是否四人各一杠
    if kanCount == 4 {
        for i := 0; i < 4; i++ {
            if kanByPlayer[i] == 0 {
                return false
            }
        }
        return true
    }
    
    return false
}
```

## 五、常见问题

### Q1: 流局后点数会变化吗？

**A**: 会。根据听牌状态进行听牌罚符结算。

### Q2: 流局后庄家会连庄吗？

**A**: 如果庄家听牌，会连庄。如果庄家不听，会下庄。

### Q3: 立直棒流局时怎么处理？

**A**: 保留到下一局，继续累积。

### Q4: 九种九牌是强制流局吗？

**A**: 不是。玩家可以选择是否流局。

### Q5: 四风连打是强制流局吗？

**A**: 是。立即流局，不进行听牌罚符。

## 总结

流局是立直麻将的重要机制：

1. **多种类型**：荒牌、九种九牌、四风连打、四杠散了等
2. **听牌罚符**：不听者支付听牌者
3. **连庄判定**：根据庄家听牌状态决定
4. **立直棒保留**：流局时保留到下一局

在开发实现时，需要准确判断各种流局条件，正确处理听牌罚符和连庄判定，确保游戏规则的正确性。

